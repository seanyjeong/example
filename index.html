<!DOCTYPE html>
<html>
<head>
    <title>기록 입력 페이지</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>기록 입력 페이지</h1>
    <form id="recordForm">
        <table>
            <thead>
                <tr>
                    <th>이름</th>
                    <th>성별</th>
                    <th>대학</th>
                    <th>제멀 (cm)</th>
                    <th>메던 (m)</th>
                    <th>10m (초)</th>
                    <th>배근력 (kg)</th>
                    <th>총점</th>
                </tr>
            </thead>
            <tbody id="studentsContainer">
                <tr class="student">
                    <td>
                        <input type="text" name="studentName" required>
                        <button type="button" class="loadButton">불러오기</button>
                    </td>
                    <td>
                        <select name="gender" required>
                            <option value="male">남자</option>
                            <option value="female">여자</option>
                        </select>
                    </td>
                    <td>
                        <select name="university" required>
                            <option value="가천체육">가천체육</option>
                            <!-- 추가할 대학들 -->
                        </select>
                    </td>
                    <td><input type="number" name="recordJemul" step="0.01" required></td>
                    <td><input type="number" name="recordMedun" step="0.01" required></td>
                    <td><input type="number" name="record10m" step="0.01" required></td>
                    <td><input type="number" name="recordBackStrength" step="0.01" required></td>
                    <td class="totalScore"></td>
                </tr>
            </tbody>
        </table>
        <button type="button" id="addStudentButton">학생 추가</button>
        <button type="submit">총점 계산</button>
    </form>
    <button id="saveButton">모든 기록 저장</button>

    <script>
        document.getElementById('addStudentButton').addEventListener('click', function() {
            const studentsContainer = document.getElementById('studentsContainer');
            const newRow = studentsContainer.rows[0].cloneNode(true);
            newRow.querySelectorAll('input').forEach(input => input.value = '');
            newRow.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
            newRow.querySelector('.totalScore').innerText = '';
            newRow.querySelector('.loadButton').addEventListener('click', loadStudent);
            studentsContainer.appendChild(newRow);
        });

        document.querySelectorAll('.loadButton').forEach(button => {
            button.addEventListener('click', loadStudent);
        });

        function loadStudent(event) {
            const row = event.target.closest('.student');
            const studentName = row.querySelector('input[name="studentName"]').value;

            fetch(`https://supermax.kr:4000/get-student?name=${studentName}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`에러: ${data.error}`);
                } else if (data.message) {
                    alert(data.message);
                } else {
                    const universitySelect = row.querySelector('select[name="university"]');
                    const genderSelect = row.querySelector('select[name="gender"]');
                    data.student.forEach(record => {
                        universitySelect.value = record.university_name;
                        genderSelect.value = record.gender;
                        if (record.event_name === '제멀') {
                            row.querySelector('input[name="recordJemul"]').value = record.record;
                        } else if (record.event_name === '메던') {
                            row.querySelector('input[name="recordMedun"]').value = record.record;
                        } else if (record.event_name === '10m') {
                            row.querySelector('input[name="record10m"]').value = record.record;
                        } else if (record.event_name === '배근력') {
                            row.querySelector('input[name="recordBackStrength"]').value = record.record;
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        document.getElementById('recordForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const students = [];
            const rows = document.querySelectorAll('.student');
            rows.forEach(row => {
                const studentName = row.querySelector('input[name="studentName"]').value;
                const university = row.querySelector('select[name="university"]').value;
                const gender = row.querySelector('select[name="gender"]').value;
                const recordJemul = row.querySelector('input[name="recordJemul"]').value;
                const recordMedun = row.querySelector('input[name="recordMedun"]').value;
                const record10m = row.querySelector('input[name="record10m"]').value;
                const recordBackStrength = row.querySelector('input[name="recordBackStrength"]').value;

                students.push(
                    { name: studentName, university: university, event: '제멀', record: recordJemul, gender: gender },
                    { name: studentName, university: university, event: '메던', record: recordMedun, gender: gender },
                    { name: studentName, university: university, event: '10m', record: record10m, gender: gender },
                    { name: studentName, university: university, event: '배근력', record: recordBackStrength, gender: gender }
                );
            });

            fetch('https://supermax.kr:4000/get-total-score', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ students: students })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.querySelectorAll('.totalScore').forEach((td, index) => {
                        td.innerText = '에러';
                    });
                } else {
                    document.querySelectorAll('.student').forEach((row, index) => {
                        const totalScore = data.find(item => item.name === row.querySelector('input[name="studentName"]').value).totalScore;
                        row.querySelector('.totalScore').innerText = totalScore;
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });

        document.getElementById('saveButton').addEventListener('click', function() {
            const students = [];
            const rows = document.querySelectorAll('.student');
            rows.forEach(row => {
                const studentName = row.querySelector('input[name="studentName"]').value;
                const university = row.querySelector('select[name="university"]').value;
                const gender = row.querySelector('select[name="gender"]').value;
                const recordJemul = row.querySelector('input[name="recordJemul"]').value;
                const recordMedun = row.querySelector('input[name="recordMedun"]').value;
                const record10m = row.querySelector('input[name="record10m"]').value;
                const recordBackStrength = row.querySelector('input[name="recordBackStrength"]').value;

                students.push(
                    { name: studentName, university: university, event: '제멀', record: recordJemul, gender: gender },
                    { name: studentName, university: university, event: '메던', record: recordMedun, gender: gender },
                    { name: studentName, university: university, event: '10m', record: record10m, gender: gender },
                    { name: studentName, university: university, event: '배근력', record: recordBackStrength, gender: gender }
                );
            });

            fetch('https://supermax.kr:4000/save-scores', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ students: students })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`에러: ${data.error}`);
                } else {
                    alert('모든 기록이 성공적으로 저장되었습니다');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    </script>
</body>
</html>
